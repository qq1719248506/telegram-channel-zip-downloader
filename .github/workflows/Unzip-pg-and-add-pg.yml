name: Unzip pg and add pg

on:
  #push:
  schedule:
    - cron: 15,45 0-18,22-23 * * *
  workflow_dispatch:
  
jobs:

  run-python-script: 

    runs-on: ubuntu-latest

    steps:
     - name: Checkout
       uses: actions/checkout@v4
       with:
         fetch-depth: 0 # 获取所有历史记录，以便搜索ZIP文件
          
     - name: Set up Python 3.9
       uses: actions/setup-python@v5
       with:
        python-version: 3.9 # 可以根据需要更改 Python 版本
        
     - name: telethon download telegram channel zip
       run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python main.py
        
     - name: Get the name of the downloaded ZIP file
       id: get-zip-name
       run: |
          # 获取下载的ZIP文件名
          downloaded_zip_name=$(ls ./files/PandaGroovePG/*.zip | head -n 1)
          echo "DOWNLOADED_ZIP_NAME=$downloaded_zip_name" >> $GITHUB_ENV

     - name: List ZIP files in the repository
       id: list-zip-files
       run: |
          # 列出仓库中的所有ZIP文件
          zip_files=$(git ls-tree -r --name-only HEAD | grep '\.zip$')
          echo "ZIP_FILES=$zip_files" >> $GITHUB_ENV
          
     - name: Check if downloaded ZIP filename matches a file in the repository 
       id: check-match
       run: |
          # 检查下载的ZIP文件名是否与仓库中的ZIP文件名匹配 
          downloaded_zip_name="${DOWNLOADED_ZIP_NAME##*/}"
          zip_files="${ZIP_FILES//'%'/'\\%'}"  # 替换%字符，避免shell解释
          if echo "$zip_files" | grep -qF -- "$downloaded_zip_name"; then
            echo "ZIP filename matches a file in the repository."
            echo "ZIP_MATCH=true" >> $GITHUB_ENV
          else
            echo "ZIP filename does not match any file in the repository."
            echo "ZIP_MATCH=false" >> $GITHUB_ENV
          fi
      
     - name: Unzip file
       if: env.ZIP_MATCH == 'false'
       run: |
          unzip -o files/PandaGroovePG/*.zip -d pg
     
     - name: Upload zip To telegram-channel-zip-downloader
       if: env.ZIP_MATCH == 'false'
       run: |  
          rm -r xytv
          rm -r ./*.zip
          mv ./files/PandaGroovePG/*.zip .
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add *.zip
          git commit -m "更新zip"
          git push -f -u origin main
